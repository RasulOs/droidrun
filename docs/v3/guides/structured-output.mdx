# Structured Output (Pydantic v2)

This guide explains how to configure agents to return validated, typed objects using Pydantic v2.

## Overview

- Leverages Pydantic v2 models for schema-first outputs
- Central utility in `droidrun/agent/utils/structured_output.py`
- Agent integration via `DroidAgent.set_output_schema()` and `DroidAgent.get_output_schema_instruction()`

## Why

- Strong typing and validation of agent results
- Safer downstream usage by consumers (apps, tests, pipelines)
- Clear prompt priming with schema hints

## API

- `coerce_to_model(schema, data)` → `BaseModel | None`
- `model_json_schema(schema)` → dict JSON Schema (Pydantic v2)
- `schema_instruction(schema)` → str prompt hint

## Usage

1) Define your model

```python
from pydantic import BaseModel

class MyOutput(BaseModel):
    success: bool
    output: str
    reason: str | None = None
```

2) Configure the agent

```python
agent.set_output_schema(MyOutput)
```

3) Use prompt hint (optional)

```python
instr = agent.get_output_schema_instruction()
# Inject `instr` into your system prompt to nudge the LLM
```

Note: When you set a schema with `agent.set_output_schema(...)`, Droidrun will automatically inject a schema instruction into the CodeActAgent's system prompts during execution so the LLM is guided to produce outputs matching your schema. You can still use `get_output_schema_instruction()` if you need to customize prompts.

4) Receive validated results

At the end of the run, `DroidAgent.finalize()` attempts to coerce the raw result dict into your model. On success, `StopEvent` carries the `MyOutput` instance; otherwise a plain dict is returned.

## Notes on Pydantic v2

- Validation: `MyOutput.model_validate(data)`
- JSON schema: `MyOutput.model_json_schema()`
- Fields: `MyOutput.model_fields`

---

## End-to-End Example

```python
from pydantic import BaseModel
from droidrun.agent.droid.droid_agent import DroidAgent
from droidrun.tools import Tools


class MyOutput(BaseModel):
    success: bool
    output: str
    reason: str | None = None


# Initialize your tools and LLM (omitted here)
tools: Tools = ...
llm = ...

agent = DroidAgent(
    goal="Open app and search for flights",
    llm=llm,
    tools=tools,
    personas=[],
    reasoning=False,
    reflection=False,
    vision=False,
)

# 1) Set schema so the agent returns typed results at the end
agent.set_output_schema(MyOutput)

# 2) (Optional) Inspect the prompt instruction that will be auto-injected
print(agent.get_output_schema_instruction())

# 3) Run the agent (API will depend on your entry point)
handler = agent.run()
result_event = await handler  # StopEvent

# 4) Access the structured result
result = result_event.result  # either `MyOutput` or a plain dict
if isinstance(result, MyOutput):
    print(result.output)
else:
    # fallback dict if validation failed
    print(result.get("output"))
```

Notes:
- The LLM prompt includes a schema hint automatically (see below).
- At finalize, the raw result dict is validated with `MyOutput.model_validate(...)`.
- On success, you get a `MyOutput` instance; otherwise, the original dict.

## Prompt Injection Details

- When you call `agent.set_output_schema(...)`, `DroidAgent` will pass a short schema instruction from `agent.get_output_schema_instruction()` into `CodeActAgent`.
- `CodeActAgent` injects this instruction as an additional system message before chat history, nudging the LLM to emit JSON matching your model.
- You can still retrieve and customize the text returned by `get_output_schema_instruction()` if you want to augment your own system prompts.

## Error Handling & Logging

- Validation uses Pydantic v2 `model_validate`. Failures are logged via the `"droidrun"` logger with context (schema name, keys).
- Utility functions in `droidrun/agent/utils/structured_output.py` are the single place for schema ops:
  - `coerce_to_model(schema, data)`
    - Returns `BaseModel` instance on success.
    - Returns `None` on validation failure and logs an error with context.
  - `model_json_schema(schema)`
    - Returns JSON schema for the model.
    - Logs and re-raises on invalid input.
  - `schema_instruction(schema)`
    - Returns a concise prompt hint string derived from fields.
    - Logs and re-raises on invalid input.


## Troubleshooting

- LLM outputs not matching schema:
  - Ensure `agent.set_output_schema(...)` was called before running.
  - Inspect `agent.get_output_schema_instruction()` and consider adding your own clarifying constraints to the system prompt.
  - If the model is complex, provide example JSON in your user/system prompts.

- Validation fails with missing/incorrect fields:
  - Check the logs under the `droidrun` logger for the exact field errors.
  - Consider making some fields optional (`field: Type | None = None`) or adding validators if appropriate.
  

---

If you need a working example tailored to your app flow or want to validate an end-to-end run, reach out by opening an issue or PR with your schema and intended output format.
